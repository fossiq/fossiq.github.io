name: Deploy UI

on:
  repository_dispatch:
    types: [deploy-ui]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Clone main repo and build UI
        run: |
          git clone --depth 1 https://github.com/fossiq/root.git /tmp/fossiq
          cd /tmp/fossiq
          bun install
          bun run --filter @fossiq/kql-lezer build
          bun run --filter @fossiq/ui build

      - name: Copy built files
        run: |
          # Remove old files except .git and workflows
          find . -maxdepth 1 ! -name '.git' ! -name '.github' ! -name '.' -exec rm -rf {} +
          # Copy new build
          cp -r /tmp/fossiq/packages/ui/dist/* .
          # Ensure .nojekyll exists
          touch .nojekyll

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Deploy UI from fossiq/root"
          git push
